<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Banana Council — Chimp Judge (Mobile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html, body { height: 100%; margin: 0; background:#0f0f12; }
    .wrap {
      width: 100vw; height: 100vh;
      display: grid; place-items: center;
      overflow: hidden;
      touch-action: none; /* we manage gestures */
      position: relative;
    }
    #game {
      width: 100vw; height: auto;
      max-height: 100vh;
      image-rendering: pixelated;
      border: 2px solid #2a2a33;
      background:#1c1c25;
      display:block;
    }
    /* On-screen buttons */
    .controls {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px;
      display: flex; justify-content: space-between; gap: 12px;
      pointer-events: none;
    }
    .btn {
      pointer-events: auto;
      user-select: none;
      width: 32vw; max-width: 200px; aspect-ratio: 1.6 / 1;
      background: rgba(0,0,0,0.55);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      display: grid; place-items: center;
      color: #eaeaf6; font: 18px/1 monospace;
    }
    .btn:active { background: rgba(0,0,0,0.75); }

    /* Start overlay */
    .overlay {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      background: rgba(0,0,0,0.82);
      color: #fff;
      font-family: monospace;
      z-index: 10;
    }
    .start {
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px solid #fff;
      background: #111;
      cursor: pointer;
      font-size: 16px;
    }
    .loading {
      margin-top: 10px;
      font-size: 12px;
      opacity: 0.85;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="136" height="88" aria-label="Chimp Judge"></canvas>

    <div class="overlay" id="overlay">
      <div>
        <button class="start" id="startBtn">Start</button>
        <div class="loading" id="loadMsg" style="display:none;">Loading…</div>
      </div>
    </div>

    <div class="controls" aria-hidden="false">
      <div class="btn" id="btn-left">◀</div>
      <div class="btn" id="btn-right">▶</div>
    </div>
  </div>

  <script>
  // ---------- ASSETS (per-frame sequences) ----------
  const ASSETS = {
    bg: 'assets/backgrounds/courtroom.png',
    sfx: 'assets/sfx/fart.wav',
    chimpIdle: (i)=>`assets/characters/chimp/chimp_npc_idle/${i}.png`,  // 0..3
    moleIdle:  (i)=>`assets/characters/mole/mole_npc_idle/${i}.png`,    // 0..3
    judgeIdle: (i)=>`assets/characters/judge/judge_idle/${i}.png`,      // 0..3
    judgeWalk: (i)=>`assets/characters/judge/judge_walk/${i}.png`,      // 0..5
    judgeFart: (i)=>`assets/characters/judge/judge_fart/${i}.png`       // 0..4
  };
  const COUNTS = { chimpIdle:4, moleIdle:4, judgeIdle:4, judgeWalk:6, judgeFart:5 };

  // ---------- Canvas / world ----------
  const FRAME_W = 64, FRAME_H = 64;     // draw at native size (no scaling)
  const SPEED = 0.12;                   // slow walk across scene (px/ms)
  const PROMPT_RADIUS = 18;             // when close enough to show label
  const FART_FALLBACK_MS = 800;         // if audio can't play/end event fails

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: false });
  let GROUND_Y = canvas.height - 1;

  // ---------- Input ----------
  const hold = { left:false, right:false };
  function bindHold(el, key){
    const on = ()=>hold[key]=true, off=()=>hold[key]=false;
    el.addEventListener('touchstart', (e)=>{on(); e.preventDefault();}, {passive:false});
    el.addEventListener('touchend',   (e)=>{off(); e.preventDefault();}, {passive:false});
    el.addEventListener('touchcancel',(e)=>{off(); e.preventDefault();}, {passive:false});
    el.addEventListener('mousedown',  (e)=>{on(); e.preventDefault();});
    el.addEventListener('mouseup',    (e)=>{off(); e.preventDefault();});
    el.addEventListener('mouseleave', ()=>{off();});
  }
  bindHold(document.getElementById('btn-left'), 'left');
  bindHold(document.getElementById('btn-right'),'right');

  canvas.addEventListener('touchstart', handleTap, {passive:false});
  canvas.addEventListener('mousedown',  (e)=>handleTap(mouseToCanvas(e)));
  function mouseToCanvas(e){
    const r=canvas.getBoundingClientRect();
    const sx=canvas.width/r.width, sy=canvas.height/r.height;
    return {clientX:e.clientX, clientY:e.clientY, _sx:sx, _sy:sy, _rect:r};
  }
  function handleTap(e){
    if (!started) return; // ignore taps before start
    const t = e.changedTouches ? e.changedTouches[0] : e;
    const rect = t._rect || canvas.getBoundingClientRect();
    const sx   = t._sx   || (canvas.width/rect.width);
    const sy   = t._sy   || (canvas.height/rect.height);
    const cx = (t.clientX - rect.left) * sx;
    const cy = (t.clientY - rect.top)  * sy;
    tryInteract(cx, cy);
    if (e.preventDefault) e.preventDefault();
  }

  // ---------- Loaders ----------
  function loadImage(src){
    return new Promise(res=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>res(null);
      img.src=src;
    });
  }
  async function loadSeq(builder, count){
    const out=[];
    for(let i=0;i<count;i++) out.push(await loadImage(builder(i)));
    return out.every(Boolean) ? out : null;
  }
  function makeAudio(src){
    try{ return new Audio(src); }catch(_){ return null; }
  }

  const Images = {
    bg:null,
    chimpIdle:null, moleIdle:null,
    judgeIdle:null, judgeWalk:null, judgeFart:null
  };
  let fartAudio = null;

  // ---------- Entities ----------
  const player = { x: 0, y: 0, facing: 1, state:'idle', anim:0, fartTimer: null };
  const chimp  = { x: 0, y: 0, anim:0, label:'Coyne'    };
  const mole   = { x: 0, y: 0, anim:0, label:'Holland'  };

  function placeEntities(){
    // keep NPCs just inside the edges (native frame size)
    const margin = Math.max(6, Math.floor(FRAME_W/2) + 2);
    chimp.x = margin;                 chimp.y = GROUND_Y;
    mole.x  = canvas.width - margin;  mole.y  = GROUND_Y;
    player.x = Math.floor(canvas.width / 2); player.y = GROUND_Y;
  }

  function distX(a,b){ return Math.abs(a.x - b.x); }
  function facingToward(from, to){ return (to.x < from.x) ? -1 : 1; }

  // ---------- Draw helpers (native size) ----------
  function drawFrame(img, x,
